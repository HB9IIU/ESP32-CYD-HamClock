<!DOCTYPE html>
<html class="bg-dark" lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
        <title>HamClock</title>
        <!-- Bootstrap 5 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
        <!-- iro.js CDN -->
        <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
        <style>#colorPicker { margin: 0 auto; display: block; }</style>
        <link href="https://fonts.googleapis.com/css?family=Victor+Mono&display=swap" rel="stylesheet">
        <style>.time-container { border: 4px solid #000;  /* Default border color */ border-radius: 10px;  /* Rounded corners */ padding: 10px 20px;  /* Padding around the text */ display: inline-block;  /* Allow the container to adjust width based on content */ text-align: center; font-family: 'Victor Mono', monospace; font-size: 40px; font-weight: 700; } .form-check { display: flex; align-items: center; margin-bottom: 10px;  /* Spacing between lines */ } .form-check input { margin-right: 10px;  /* Space between radio button and label */ } .color-picker-container { display: inline-block; margin-left: 10px; } /* Create space between the two time containers */.time-container-wrapper { display: flex; gap: 30px;  /* Space between local and UTC time containers */ } /* Scrolling banner animation */.weather-banner { white-space: nowrap; overflow: hidden; width: 100%;  /* Full width container */ display: flex; justify-content: center; margin-top: 20px; } .weather-banner-text { animation: scrollText 10s linear infinite; font-size: 30px; } /* Define the scrolling animation */@keyframes scrollText { 0% {  transform: translateX(100%); }  100% {  transform: translateX(-100%); } }</style>
        <link href="https://fonts.googleapis.com/css?family=Orbitron&display=swap" rel="stylesheet">
    </head>
    <body class="bg-dark">
        <div class="bg-dark container py-5">
            <div class="row" data-pg-collapsed>
                <p class="text-center text-white" style="font-family: 'Orbitron', sans-serif; font-size: 30px; font-weight: 700; margin-bottom: 30px; letter-spacing: 3px;">
            HB9IIU HamClock Configurator</p>
            </div>
            <div class="row">
                <!-- First Column: Time Display -->
                <div class="col-md-12">
                    <div class="container" data-pg-collapsed>
                        <!-- Time Containers with Flex to create a gap -->
                        <div class="row" data-pg-collapsed>
                            <div class="col-md-6">
                                <p class="text-center text-white" style="font-size: 26px; font-family: 'Orbitron', sans-serif; font-weight: 400;">Local
                            Time</p>
                            </div>
                            <div class="col-md-6">
                                <p class="text-center text-white" style="font-size: 26px; font-family: 'Orbitron', sans-serif; font-weight: 400;">UTC Time</p>
                            </div>
                        </div>
                        <div class="row" data-pg-collapsed>
                            <div class="col-md-6" style="text-align: center;">
                                <div class="time-container" id="localTime" style="font-family: 'Victor Mono', monospace; font-size: 40px; font-weight: 700;">00:00:00
</div>
                            </div>
                            <div class="col-md-6" style="text-align: center;">
                                <div class="time-container" id="utcTime" style="font-family: 'Victor Mono', monospace; font-size: 40px; font-weight: 700;">00:00:00
</div>
                            </div>
                        </div>
                        <div class="row" data-pg-collapsed>
                            <div class="col-md-6" style="text-align: center;">
                                <h3 class="text-center text-secondary" style="margin-top: -10px; font-family: 'Orbitron', sans-serif; font-size: 16px; text-align: center;"> <div contenteditable="true" id="columnTitleLocalTime" style="display: inline; background-color: black; color: white; padding: 0 5px; font-size: 16px; font-family: 'Orbitron', sans-serif;">
                                        Column title
</div> </h3>
                            </div>
                            <div class="col-md-6" style="text-align: center;">
                                <h3 class="text-center text-secondary" style="margin-top: -10px; font-family: 'Orbitron', sans-serif; font-size: 16px; text-align: center;"> <div contenteditable="true" id="columnTitleUTCtime" style="display: inline; background-color: black; color: white; padding: 0 5px; font-size: 16px; font-family: 'Orbitron', sans-serif;">
                                        Column title
</div> </h3>
                            </div>
                        </div>
                        <div class="row" data-pg-collapsed style="margin-top: 8px;">
                            <div class="col-md-6 d-flex justify-content-center align-items-center" data-pg-collapsed>
                                <div class="row" style="margin-top: 15px; text-align: center;">
                                    <div class="col-md-6 d-flex justify-content-center">
                                        <div class="form-check" style="font-size: 20px;">
                                            <input class="form-check-input" id="line3" name="line" onclick="setColorTarget('localTimeDigits')" style="font-size: 18px;" type="radio" value="line3">
                                            <label class="form-check-label text-white" for="line3" style="font-family: 'Orbitron', sans-serif; font-size: 18px;">
                                                Digits
</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 d-flex justify-content-center">
                                        <div class="form-check" style="font-size: 20px;">
                                            <input class="form-check-input" id="line4" name="line" onclick="setColorTarget('localTimeFrame')" style="font-size: 18px;" type="radio" value="line4">
                                            <label class="form-check-label text-white" for="line4" style="font-size: 18px; font-family: 'Orbitron', sans-serif;">
                                                Frame
</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex justify-content-center align-items-center" data-pg-collapsed>
                                <div class="row" data-pg-collapsed style="margin-top: 15px;">
                                    <div class="col-md-6 d-flex justify-content-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input" id="line5" name="line" onclick="setColorTarget('utcTimeDigits')" style="font-size: 18px;" type="radio" value="line5">
                                            <label class="form-check-label text-white" for="line5" style="font-size: 18px; font-family: 'Orbitron', sans-serif;">
                                                Digits
</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 d-flex justify-content-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input" id="line6" name="line" onclick="setColorTarget('utcTimeFrame')" style="font-size: 18px;" type="radio" value="line6">
                                            <label class="form-check-label text-white" for="line6" style="font-size: 18px; font-family: 'Orbitron', sans-serif;">
                                                Frame
</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" data-pg-collapsed>
                            <div class="col-md-6 float-none text-center">
                                <input class="form-check-input" id="thinBorderCheckbox" onclick="toggleBorderThickness()" style="font-size: 18px;" type="checkbox">
                                <label class="form-check-label text-white" for="thinBorderCheckbox" style="font-size: 18px; font-family: 'Orbitron', sans-serif;">
                                    Thin Border
</label>
                            </div>
                            <div class="col-md-6 float-none text-center">
                                <input class="form-check-input" id="italicFontsBorderCheckbox" onclick="sendItalicFontSetting()" style="font-size: 18px;" type="checkbox">
                                <label class="form-check-label text-white" for="thinBorderCheckbox" style="font-size: 18px; font-family: 'Orbitron', sans-serif;">
                                    Italic Fonts
</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="text-white weather-banner" data-pg-collapsed style="font-family: 'Orbitron', sans-serif;">
                                <div class="bg-dark weather-banner-text" id="weatherBannerText" style="color: #915656;">Local
                                    Weather Information and
                                    Astronomical Data
</div>
                            </div>
                            <!-- Slider for adjusting the scrolling speed -->
                            <div class="row" data-pg-collapsed style="margin-top: 20px;">
</div>
                            <div class="form-check d-flex justify-content-center" data-pg-collapsed>
                                <input class="form-check-input" id="line7" name="line" onclick="setColorTarget('weatherBannerText')" style="font-size: 18px;" type="radio" value="line7">
                                <label class="form-check-label text-white" for="line7" style="font-size: 18px; font-family: 'Orbitron', sans-serif;">
                                    Weather Info Banner
</label>
                            </div>
                            <div class="col-md-12 text-center">
                                <div class="row" style="margin-bottom: 20px; display: flex; justify-content: center;">
                                    <input id="speedSlider" max="45" min="0" step="1" style="width: 80%; margin-top: 10px;" type="range" value="10">
                                </div>
                            </div>
                        </div>
                        <div class="row" data-pg-collapsed>
                            <div class="col-md-6 text-center" data-pg-collapsed>
                                <p class="text-white" style="font-family: 'Orbitron', sans-serif; font-size: 20px;">Latitude</p>
                                <input id="latitudeInput" type="number" step="any" style="font-family: 'Orbitron', sans-serif; text-align: center;">
                            </div>
                            <div class="col-md-6 text-center">
                                <p class="text-white" style="font-family: 'Orbitron', sans-serif; font-size: 20px;">
                            Longitude</p>
                                <input id="longitudeInput" type="number" step="any" style="font-family: 'Orbitron', sans-serif; text-align: center;">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Second Column: Color Picker -->
            </div>
            <div class="row" data-pg-collapsed>
                <div class="col-12" style="text-align: center;">
                    <div class="color-picker-container" id="colorPicker" style="display: inline-block;">
                        <div class="IroColorPicker" style="display: block;"></div>
                    </div>
                </div>
            </div>
            <div class="row" data-empty-placeholder></div>
            <div class="row mt-3">
                <div class="col text-center">
                    <button id="saveAllButton" type="button" class="btn btn-light px-4 py-2" style="font-family: 'Orbitron', sans-serif; font-weight: 700; display: inline-block;">
                        Save All To Flash Memory
</button>
                </div>
            </div>
        </div>
        <!-- Bootstrap JS (optional) -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Initialize iro.js -->
        <script>



    const labelIdToTarget = {
        columnTitleLocalTime: "localTimeLabel",
        columnTitleUTCtime: "utcTimeLabel"
    };











    // Create one color picker for all elements
    const colorPicker = new iro.ColorPicker("#colorPicker", {
        width: 200,
        color: "#76c72a"
    });

    // Initialize the target element for color change (initially set to localTimeDigits)
    let currentTarget = 'localTimeDigits';

    // Function to set the target element for color change
    function setColorTarget(target) {
        currentTarget = target;
        console.log("Selected target: ", target);
    }

    // Listen to color changes and update the selected element's color
    colorPicker.on("color:change", function (color) {
        if (currentTarget === 'localTimeDigits') {
            document.getElementById("localTime").style.color = color.hexString;
        } else if (currentTarget === 'localTimeFrame') {
            document.getElementById("localTime").style.borderColor = color.hexString;
        } else if (currentTarget === 'utcTimeDigits') {
            document.getElementById("utcTime").style.color = color.hexString;
        } else if (currentTarget === 'utcTimeFrame') {
            document.getElementById("utcTime").style.borderColor = color.hexString;
        } else if (currentTarget === 'weatherBannerText') {
            document.getElementById("weatherBannerText").style.color = color.hexString;
        }
    });

    function rgb565FromHex(hex) {
        const r = parseInt(hex.substr(1, 2), 16);
        const g = parseInt(hex.substr(3, 2), 16);
        const b = parseInt(hex.substr(5, 2), 16);

        const r5 = Math.round((r * 31) / 255) & 0x1F;
        const g6 = Math.round((g * 63) / 255) & 0x3F;
        const b5 = Math.round((b * 31) / 255) & 0x1F;

        return (r5 << 11) | (g6 << 5) | b5;
    }

    // Function to format the time as HH:MM:SS
    function formatTime(date) {
        let hours = date.getHours();
        let minutes = date.getMinutes();
        let seconds = date.getSeconds();

        // Add leading zeros if the numbers are less than 10
        hours = hours < 10 ? '0' + hours : hours;
        minutes = minutes < 10 ? '0' + minutes : minutes;
        seconds = seconds < 10 ? '0' + seconds : seconds;

        return `${hours}:${minutes}:${seconds}`;
    }

    // Function to update the current local and UTC time
    function updateTime() {
        const localTime = new Date();
        const utcTime = new Date(localTime.toUTCString()); // Create a UTC version of the local time

        // Format the times
        const formattedLocalTime = formatTime(localTime);
        const formattedUtcTime = formatTime(utcTime);

        // Update the labels with the respective times
        document.getElementById("localTime").innerText = formattedLocalTime;
        document.getElementById("utcTime").innerText = formattedUtcTime;
    }

    // Call updateTime every second to keep the times updated
    setInterval(updateTime, 1000);
    updateTime(); // Initial call to set the times immediately

    // Function to toggle the border thickness
    function toggleBorderThickness() {
        const thinBorderCheckbox = document.getElementById("thinBorderCheckbox");

        // Check the checkbox state and adjust border thickness
        if (thinBorderCheckbox.checked) {
            // Thin border
            document.getElementById("localTime").style.borderWidth = "3px";
            document.getElementById("utcTime").style.borderWidth = "3px";
        } else {
            // Thick border
            document.getElementById("localTime").style.borderWidth = "6px";
            document.getElementById("utcTime").style.borderWidth = "6px";
        }
    }

    // Get the slider and the weather banner text
    const speedSlider = document.getElementById('speedSlider');
    const weatherBannerText = document.getElementById('weatherBannerText');

    // Set the initial animation duration (10 seconds as default)
    let speed = speedSlider.value;

    // Update the animation duration of the scrolling text (inverted)
    weatherBannerText.style.animationDuration = (31 - speed) + 's'; // Inverted slider logic

    // Add an event listener to the slider to change the scroll speed
    speedSlider.addEventListener('input', function () {
        const sliderValue = parseInt(speedSlider.value); // 0–45
        const bannerSpeed = Math.max(0, Math.min(40, 40 - sliderValue)); // 0 to 40 (for ESP32)

        const animationDuration = 5 + (bannerSpeed / 40) * 40; // 5s to 45s (for web)
        weatherBannerText.style.animationDuration = animationDuration + 's';

        fetch('/setspeed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ speed: bannerSpeed })
        }).then(response => {
            if (!response.ok) throw new Error("Failed to send speed");
            console.log("🚀 Speed updated on ESP32:", bannerSpeed);
        }).catch(err => {
            console.error("❌ Error sending speed:", err);
        });
    });





    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/config');
            const config = await response.json();

            // 🌍 Set latitude & longitude
            document.getElementById("latitudeInput").value = config.latitude;
            document.getElementById("longitudeInput").value = config.longitude;


            // 🕓 Set time labels
            document.getElementById("columnTitleLocalTime").innerText = config.localTimeLabel;
            document.getElementById("columnTitleUTCtime").innerText = config.utcTimeLabel;

            // 🔠 Italic Fonts checkbox
            document.getElementById("italicFontsBorderCheckbox").checked = config.italicClockFonts;

            // ⬛ Thin Border checkbox
            document.getElementById("thinBorderCheckbox").checked = config.doubleFrame;

            // 🐢 Slider speed
            const slider = document.getElementById("speedSlider");
            slider.value = config.bannerSpeed;
            weatherBannerText.style.animationDuration = (31 - config.bannerSpeed) + 's';

            // 🎨 Set initial banner text color
            document.getElementById("weatherBannerText").style.color = hexFrom565(config.bannerColour);

            // 🎨 Set initial frame/digit colors (optional depending on your current target)
            document.getElementById("localTime").style.borderColor = hexFrom565(config.localFrameColour);
            document.getElementById("utcTime").style.borderColor = hexFrom565(config.utcFrameColour);
            document.getElementById("localTime").style.color = hexFrom565(config.localTimeColour);
            document.getElementById("utcTime").style.color = hexFrom565(config.utcTimeColour);

            // ✅ Attach handlers to editable time labels (Enter to save, no newline)
            ['columnTitleLocalTime', 'columnTitleUTCtime'].forEach(id => {
                const el = document.getElementById(id);

                el.addEventListener('blur', () => {
                    const target = labelIdToTarget[id]; // 🔁 Map ID to config key
                    const value = el.innerText.trim();
                    if (value !== '') {
                        sendLabelUpdate(target, value);
                    }
                });

                el.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // ✅ Prevent newline
                        el.blur();          // ✅ Save label via blur
                    }
                });
            });

// 🛰️ Attach handler for latitude & longitude updates
            ['latitudeInput', 'longitudeInput'].forEach(id => {
                const el = document.getElementById(id);

                el.addEventListener('blur', () => {
                    sendPositionUpdate();
                });

                el.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        el.blur(); // trigger blur to send
                    }
                });
            });

// 📤 Send new lat/lon to ESP32
            function sendPositionUpdate() {
                const latitude = document.getElementById("latitudeInput").value.trim();
                const longitude = document.getElementById("longitudeInput").value.trim();

                if (latitude !== '' && longitude !== '') {
                    fetch('/setposition', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ latitude, longitude })
                    })
                        .then(res => {
                            if (!res.ok) throw new Error("Failed to update position");
                            console.log(`📍 Position updated: lat=${latitude}, lon=${longitude}`);
                        })
                        .catch(err => {
                            console.error("❌ Error updating position:", err);
                        });
                }
            }





            try {
                const textResponse = await fetch('/scrolltext');
                const bannerText = await textResponse.text();
                document.getElementById("weatherBannerText").innerText = bannerText;
            } catch (err) {
                console.error("❌ Failed to fetch scrollText:", err);
            }


        } catch (err) {
            console.error("❌ Failed to fetch config:", err);
        }
    });

    // Helper to convert 16-bit RGB565 to hex string
    function hexFrom565(rgb565) {
        let r = ((rgb565 >> 11) & 0x1F) * 255 / 31;
        let g = ((rgb565 >> 5) & 0x3F) * 255 / 63;
        let b = (rgb565 & 0x1F) * 255 / 31;

        r = Math.round(r);
        g = Math.round(g);
        b = Math.round(b);

        return `#${[r, g, b].map(x => x.toString(16).padStart(2, '0')).join('')}`;
    }


    colorPicker.on("color:change", function (color) {
        const colorHex = color.hexString;
        const rgb565 = rgb565FromHex(colorHex);

        // Apply color visually
        if (currentTarget === 'localTimeDigits') {
            document.getElementById("localTime").style.color = colorHex;
        } else if (currentTarget === 'localTimeFrame') {
            document.getElementById("localTime").style.borderColor = colorHex;
        } else if (currentTarget === 'utcTimeDigits') {
            document.getElementById("utcTime").style.color = colorHex;
        } else if (currentTarget === 'utcTimeFrame') {
            document.getElementById("utcTime").style.borderColor = colorHex;
        } else if (currentTarget === 'weatherBannerText') {
            document.getElementById("weatherBannerText").style.color = colorHex;
        }

        // Send update to ESP32
        fetch('/setcolor', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({target: currentTarget, color: rgb565})
        }).then(response => {
            if (!response.ok) throw new Error("Failed to send color");
            console.log("✅ Color sent to ESP32:", currentTarget, colorHex);
        }).catch(err => {
            console.error("❌ Error sending color:", err);
        });
    });

    document.getElementById("thinBorderCheckbox").addEventListener("change", function () {
        const doubleFrame = this.checked;

        fetch("/setcolor", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({target: "doubleFrame", value: doubleFrame})
        })
            .then((res) => {
                if (!res.ok) throw new Error("Failed to update doubleFrame");
                console.log("🖼️ doubleFrame updated:", doubleFrame);
            })
            .catch((err) => console.error("❌ Error updating doubleFrame:", err));
    });

    function sendLabelUpdate(id, value) {
        fetch('/setlabel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ target: id, value })  // <- FIXED KEY
        }).then(res => {
            if (!res.ok) throw new Error("Failed to update label");
            console.log(`✅ Label updated: ${id} = "${value}"`);
        }).catch(err => {
            console.error("❌ Error updating label:", err);
        });
    }

    function sendItalicFontSetting() {
        const italic = document.getElementById("italicFontsBorderCheckbox").checked;

        fetch("/setitalic", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ italicClockFonts: italic })
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to update italicClockFonts");
                console.log("✏️ italicClockFonts updated:", italic);
            })
            .catch(err => console.error("❌ Error updating italicClockFonts:", err));
    }

    document.getElementById("saveAllButton").addEventListener("click", function () {
        fetch('/saveall', {
            method: 'POST'
        }).then(res => {
            if (!res.ok) throw new Error("Failed to save settings");
            alert("✅ All settings saved to flash!");
        }).catch(err => {
            console.error("❌ Error saving settings:", err);
            //alert("❌ Failed to save settings");
        });
    });


</script>
    </body>
</html>
